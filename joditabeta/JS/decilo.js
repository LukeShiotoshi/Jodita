document.addEventListener('DOMContentLoaded', function () {
    const startGameBtn = document.getElementById('start-game');
    const playerNamesInput = document.getElementById('player-names');
    const playerCount = document.getElementById('player-count');
    const decreaseBtn = document.getElementById('decrease-players');
    const increaseBtn = document.getElementById('increase-players');
    const setupForm = document.getElementById('setup-form');
    const challengeContainer = document.getElementById('challenge-container');
    const restartGameBtn = document.getElementById('restart-game');
    const input = document.getElementById('player-names');
    const msg = document.getElementById('tilin-msg');
    const audio = document.getElementById('tilin-audio');

    let tilinActivado = false;

    input.addEventListener('input', (e) => {
        const value = e.target.value.toLowerCase();

        if ((value.includes('til√≠n') || value.includes('tilin')) && !tilinActivado) {
            tilinActivado = true;

            // Mostrar mensaje
            msg.classList.remove('hidden');

            // Reproducir audio
            audio.play();
            audio.loop = false;
            setTimeout(() => {
                audio.pause();
                audio.currentTime = 0; // Reinicia el audio para que est√© listo si se vuelve a activar
            }, 8000);


            // Vibraci√≥n
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }

            // Confeti üéä
            import('https://cdn.skypack.dev/canvas-confetti').then((confetti) => {
                confetti.default({
                    particleCount: 1000,
                    spread: 700,
                    origin: { y: 0.4 },
                    colors: ['#ff00cc', '#00ffff', '#ffff00'],
                });
            });

            // Ocultar mensaje despu√©s de 4 segundos
            setTimeout(() => {
                msg.classList.add('hidden');
            }, 4000);
        }

        // Resetear si se borra "til√≠n"
        if (!value.includes('til√≠n') && !value.includes('tilin')) {
            tilinActivado = false;
        }
    });


    // Local challenges for each category
    const challenges = {
        'hot-dares': [
            "Lame el cuello de la persona que elijas.",
            "Mand√° un mensaje hot a alguien del grupo (ellos eligen a qui√©n).",
            "Sacate una prenda (menos ropa interior).",
            "Simul√° un orgasmo frente al grupo.",
            "Cont√° tu experiencia sexual m√°s rara.",
            "Eleg√≠ a alguien y toc√° su abdomen.",
            "Dec√≠ en voz alta tu historial de b√∫squedas m√°s hot.",
            "Mand√° un audio sexy diciendo lo primero que se te venga a la cabeza.",
            "Describ√≠ tu posici√≥n sexual favorita sin decir su nombre.",
            "Mand√° un mensaje con doble sentido al √∫ltimo contacto que tengas en WhatsApp.",
            "Toc√° la pierna de alguien por debajo de la mesa por un minuto.",
            "Dec√≠ en voz alta algo que te caliente mucho.",
            "Chup√° un dedo ajeno durante 5 segundos.",
            "Bes√° a alguien en la mejilla pero hacelo durar inc√≥modamente mucho.",
            "Mir√° fijo a alguien y decile algo que te imagin√°s haciendo con esa persona.",
            "Mand√° un emoji caliente a un contacto reciente y no pod√©s dar contexto si pregunta.",
            "Simul√° c√≥mo besar√≠as apasionadamente, usando solo el aire.",
            "Susurrale algo hot al o√≠do a la persona de tu derecha.",
            "Eleg√≠ a alguien y hac√© un masaje en la espalda.",
            "Mostr√° tu mejor cara de placer sin decir una palabra.",
            "Narr√° c√≥mo ser√≠a una cita sexual perfecta sin decir ninguna mala palabra.",
            "Chup√° un cubo de hielo lentamente y mir√° a alguien a los ojos mientras lo hac√©s.",
            "Dec√≠ tu zona er√≥gena favorita y por qu√©.",
            "Mand√° un voice actuando como si estuvieras teniendo sexo (sin decir palabras expl√≠citas).",
            "Toc√° lentamente el brazo de alguien mientras le dec√≠s algo sugerente.",
            "Simul√° que est√°s por seducir a alguien del grupo e improvis√° el momento.",
            "Mostr√° la √∫ltima foto que recibiste por chat (sin contexto).",
            "Dec√≠ con qui√©n del grupo har√≠as un tr√≠o y por qu√©.",
            "Eleg√≠ a alguien para que te d√© una orden hot que ten√©s que cumplir o tomar 3.",
            "Bail√° reggaet√≥n lento con alguien del grupo.",
            "Dec√≠ con qui√©n tendr√≠as una noche sin compromiso, ac√° y ahora.",
            "Recre√° una escena hot de una serie o pel√≠cula.",
            "Hac√© contacto visual con alguien y decile, sin re√≠rte, lo que le har√≠as en una noche de pasi√≥n.",
            "Describ√≠ en detalle c√≥mo ser√≠a tu primera vez con alguien del grupo (sin decir qui√©n).",
            "Simul√° que est√°s teniendo sexo telef√≥nico con alguien.",
            "Dej√° que alguien del grupo elija una parte de tu cuerpo para que la besen (con consentimiento).",
            "Cont√° un sue√±o sexual que hayas tenido (real o inventado, pero cre√≠ble).",
            "Eleg√≠ a alguien y describ√≠ c√≥mo lo/a besar√≠as, paso a paso.",
            "Toc√° suavemente el cuello de alguien mientras dec√≠s algo caliente al o√≠do.",
            "Imit√° un gemido real tuyo durante 10 segundos sin parar.",
            "Mostr√° tu outfit interior solo con gestos, sin sacarte nada.",
            "Jug√° al piedra, papel o tijera con alguien. El que pierde deja que el otro le d√© una mordida suave donde quiera (con consentimiento).",
            "Mand√° un mensaje diciendo 'No paro de pensar en lo que pas√≥ anoche' al contacto que el grupo elija.",
            "Dec√≠ cu√°l fue el lugar m√°s raro donde tuviste algo hot y c√≥mo fue.",
            "Toc√° lentamente los labios (los tuyos) mientras le habl√°s sucio al aire.",
            "Actu√° c√≥mo si estuvieras a punto de tener sexo pero te interrumpen y ten√©s que disimular.",
            "Dej√° que alguien elija una parte de tu cuerpo para escribir con el dedo una palabra hot.",
            "Hac√© un mini striptease con una prenda que no sea ropa interior.",
            "Dec√≠ una fantas√≠a que nunca cumpliste pero que te encantar√≠a.",
            "Sentate en las piernas de alguien durante toda la siguiente ronda.",
            "Mand√° un mensaje privado con un deseo hot a alguien del grupo (no pod√©s decir a qui√©n).",
            "Imit√° c√≥mo te mojar√≠as si alguien te tocara justo donde m√°s te gusta (sin decir d√≥nde).",
            "Describ√≠ qu√© parte del cuerpo de cada uno del grupo te parece m√°s sexy.",
            "Toc√° con los labios (sin besar) el cuello de alguien.",
            "Simul√° c√≥mo reaccion√°s cuando te muerden el cuello.",
            "Cont√° c√≥mo fue tu primer beso y cu√°nto te calent√≥ (o inventalo bien).",
            "Dej√° que el grupo elija a alguien para que te d√© un beso donde quiera (con consentimiento).",
            "Le√© en voz alta el primer mensaje hot que recuerdes haber mandado o inventalo si no ten√©s.",
            "Eleg√≠ a alguien para hacer una pose sexual improvisada juntos durante 5 segundos.",
            "Simul√° c√≥mo te desvest√≠s cuando est√°s solo/a y ten√©s ganas.",
            "Recre√° el audio m√°s hot que hayas recibido (o inventalo con estilo).",
            "Cont√° a qui√©n del grupo le har√≠as un masaje √≠ntimo y por qu√©.",
            "Actu√° como si estuvieras teniendo un encuentro hot con un desconocido en un ba√±o p√∫blico."
        ],

        'drinking-dares': [
            "Tom√° un trago con los ojos cerrados y sin manos.",
            "Eleg√≠ a dos personas para hacer fondo blanco con vos.",
            "Hacete un trago improvisado con lo que haya en la mesa.",
            "Jug√° piedra papel o tijera: el que pierde, toma tres.",
            "Tir√° un dado: si sac√°s n√∫mero par, tom√°s doble.",
            "Eleg√≠ a alguien para que tome en tu lugar y respond√© una pregunta por ellos.",
            "Imit√° a alguien del grupo mientras tom√°s.",
            "Dec√≠ algo rid√≠culo y brind√° por eso.",
            "Tom√° mientras hac√©s una declaraci√≥n dram√°tica.",
            "Hac√© fondo blanco sin fruncir la cara.",
            "Hac√© un brindis mencionando tres cosas random y tom√°.",
            "Intercambi√° vaso con alguien y tom√° sin chistar.",
            "Eleg√≠ un objeto y brind√° por √©l como si fuera tu √≠dolo.",
            "Tom√° con el codo apoyado en la frente.",
            "Tom√° mientras dec√≠s algo completamente absurdo y convencido.",
            "Eleg√≠ a alguien para que te d√© el trago directamente (con consentimiento).",
            "Ponete un sombrero o algo en la cabeza y no pod√©s tomar hasta que no se caiga.",
            "Tom√° mirando fijamente a alguien como si le estuvieras confesando tu amor.",
            "Cont√° una an√©cdota graciosa o embarazosa y despu√©s tom√°.",
            "Dej√° que el grupo te invente un apodo nuevo y brind√° por eso.",
            "Tom√° desde un recipiente raro (taza, frasco, botella de otra cosa, etc).",
            "Eleg√≠ a alguien para que mezclete un trago sorpresa y ten√©s que tomarlo s√≠ o s√≠.",
            "Jug√° a que est√°s en una cita inc√≥moda mientras tom√°s.",
            "Hac√© fondo blanco mientras hac√©s una pose rid√≠cula.",
            "Nombr√° tres cosas que te dan cringe y despu√©s hacete un trago por cada una.",
            "Invent√° un brindis como si estuvieras en un casamiento y tom√° como si fuera champ√°n.",
            "Pas√° tu vaso de mano en mano hasta volver a vos, y el que lo tiene al final tambi√©n toma.",
            "Tom√° mientras ten√©s que responder preguntas r√°pidas del grupo sin trabarte.",
            "Hac√© un brindis por una serie o peli que odies y defendela como si fuera tu favorita.",
            "Tom√° cada vez que alguien dice 'dale', 'ya fue' o 'posta' durante la pr√≥xima ronda.",
            "Simul√° que est√°s en un programa de cocina y ense√±√° a preparar tu trago mientras lo hac√©s.",
            "Tom√° mientras hac√©s un mini mon√≥logo sobre lo injusto que es algo random.",
            "Agarr√° el vaso con una parte del cuerpo que no sea la mano y trat√° de tomar as√≠.",
            "Eleg√≠ a alguien y ten√©s que imitar c√≥mo tomar√≠a √©l/ella si fuera un famoso o influencer.",
            "Mostr√° c√≥mo ser√≠a tomar con resaca y despu√©s tom√° posta.",
            "Brind√° como si acabaras de ganar un Oscar y agradec√© a alguien del grupo.",
            "Tom√° mientras actu√°s que est√°s en una fiesta cheta y habl√°s con acento snob.",
            "Hacete el borracho exagerado mientras tom√°s (aunque no lo est√©s).",
            "Pon√© una canci√≥n triste y tom√° como si te hubieran dejado ayer.",
            "Simul√° estar en un brindis de A√±o Nuevo, grit√° el conteo regresivo y tom√°.",
            "Tom√° pero solo si logr√°s hacer equilibrio con una moneda en la frente.",
            "Eleg√≠ a alguien y hac√© fondo blanco con √©l/ella pero mirando para otro lado todo el tiempo.",
            "Ten√©s que tomar solo si alguien del grupo puede nombrar 3 tragos.",
            "Jug√° piedra papel o tijera con alguien: el que pierde, toma el doble.",
            "Pon√© una canci√≥n y tom√° cada vez que digan una palabra espec√≠fica."],

        'uncomfortable-truths': [
            "¬øQui√©n te cae peor del grupo?",
            "¬øQu√© pensaste la primera vez que viste a tu crush?",
            "¬øAlguna vez hablaste mal de alguien de ac√°?",
            "¬øPrefer√≠s gustarle a todos o a nadie?",
            "¬øQu√© parte de tu cuerpo te da verg√ºenza?",
            "¬øA qui√©n nunca invitar√≠as de nuevo a una joda?",
            "¬øQu√© mentira dijiste √∫ltimamente y a√∫n no confesaste?",
            "¬øQui√©n es el m√°s falso del grupo?",
            "¬øA qui√©n te chapar√≠as solo por curiosidad?",
            "¬øQu√© parte de vos te cuesta aceptar?",
            "¬øAlguna vez saboteaste a un amigo sin que se entere?",
            "¬øQu√© secreto sab√©s de alguien ac√° y nunca contaste?",
            "¬øAlguna vez fuiste infiel o estuviste con alguien que lo fue?",
            "¬øQu√© fue lo m√°s raro que stalkaste en redes?",
            "¬øA qui√©n le mentiste √∫ltimamente aunque no parezca?",
            "¬øQu√© hiciste que si alguien del grupo se entera, se enoja seguro?",
            "¬øAlguna vez tuviste celos de alguien de ac√°? ¬øPor qu√©?",
            "¬øCon qui√©n te gustar√≠a tener algo aunque nunca lo admitir√≠as en serio?",
            "¬øA qui√©n ignor√°s en el grupo sin que se note?",
            "¬øQu√© cosa que hiciste te da culpa y nunca lo contaste?",
            "¬øTe gusta alguien del grupo y no lo dijiste jam√°s?",
            "¬øQu√© parte de tu personalidad escond√©s para caer bien?",
            "¬øDe qui√©n del grupo pensaste algo heavy que no te animaste a decirle en la cara?",
            "¬øQu√© mensaje borraste porque sab√≠as que si lo ve√≠an te quemabas mal?",
            "¬øA qui√©n te gustar√≠a que echen de este juego y por qu√©?",
            "¬øCu√°l fue la peor traici√≥n que hiciste a alguien cercano?",
            "¬øQu√© pens√°s que el grupo no se anima a decirte en la cara?",
            "¬øCu√°l fue el comentario m√°s mala leche que hiciste de alguien presente?",
            "¬øAlguna vez mentiste sobre algo heavy para zafar de una situaci√≥n con alguien de ac√°?",
            "¬øQu√© pensamiento oscuro ten√©s seguido pero nunca cont√°s?",
            "¬øCon qui√©n tuviste una tensi√≥n rara y nunca lo hablaron?",
            "¬øA qui√©n le har√≠as ghosting si pudieras sin culpa?",
            "¬øQu√© hiciste que no fue ilegal pero sab√©s que estuvo muy mal?",
            "¬øQu√© cosa de vos te da verg√ºenza pero sab√©s que no vas a cambiar igual?",
            "¬øQu√© cosa que hiciste con alguien te arrepent√≠s pero segu√≠s actuando como si nada?",
            "¬øAlguna vez deseaste que alguien del grupo fracase o no le salga algo?",
            "¬øA qui√©n le sac√°s el cuerpo o evit√°s cada vez que pod√©s?",
            "¬øCu√°l es el pensamiento m√°s t√≥xico que tuviste esta semana y a qui√©n involucraba?",
            "¬øCon qui√©n ser√≠as re intenso si supieras que nadie se va a enterar?",
            "¬øQu√© persona de tu pasado todav√≠a te afecta aunque lo neg√°s?",
            "¬øQu√© es lo m√°s manipulador que hiciste y te funcion√≥?",
            "¬øA qui√©n del grupo bloquear√≠as por una semana y por qu√©?",
            "¬øPrefer√≠s quedar mal con todos o traicionar a un amigo cercano?"
        ],

        'intimate-truths': [
            "¬øTe enamoraste alguna vez de alguien que no te dio bola?",
            "¬øQu√© tipo de mensajes te calientan m√°s?",
            "¬øCon cu√°ntas personas chapaste?",
            "¬øTen√©s una playlist para momentos √≠ntimos?",
            "¬øAlguna vez lloraste por amor sin que nadie se entere?",
            "¬øQu√© parte del cuerpo te gusta que te toquen m√°s?",
            "¬øPrefer√≠s sexo con amor o sin compromiso?",
            "¬øCu√°l fue tu primera fantas√≠a sexual?",
            "¬øTen√©s una fantas√≠a que nunca contaste a nadie?",
            "¬øCon qui√©n tuviste el mejor beso de tu vida?",
            "¬øQu√© detalle te vuelve loco/a cuando alguien te gusta?",
            "¬øAlguna vez te enganchaste con alguien que sab√≠as que no te conven√≠a?",
            "¬øTe quedaste con ganas de algo despu√©s de una relaci√≥n?",
            "¬øPrefer√≠s mil caricias o una sola mirada que diga todo?",
            "¬øTe gusta que te dominen o dominar?",
            "¬øAlguna vez te enamoraste de alguien mientras estabas con otra persona?",
            "¬øQu√© olor te enciende sin darte cuenta?",
            "¬øTe gusta hablar sucio o prefer√≠s el silencio total?",
            "¬øAlguna vez pensaste en alguien m√°s mientras estabas con tu pareja?",
            "¬øCu√°l fue el lugar m√°s raro donde tuviste un momento √≠ntimo?",
            "¬øQu√© gesto o actitud te derrite m√°s que cualquier palabra?",
            "¬øGuard√°s mensajes o audios hot aunque ya no hables con esa persona?",
            "¬øTe excita m√°s lo que te dicen o lo que hacen?",
            "¬øAlguna vez fingiste sentir algo que no sent√≠as para no herir a alguien?",
            "¬øQu√© parte de vos cre√©s que es la m√°s atractiva en la intimidad?",
            "¬øPrefer√≠s algo intenso y corto o largo y tranqui?",
            "¬øQu√© te hace sentir realmente deseado/a?",
            "¬øAlguna vez estuviste con alguien por pura calentura aunque sab√≠as que no iba a pasar nada m√°s?",
            "¬øSos m√°s de tomar la iniciativa o esper√°s que el otro avance?",
            "¬øTe pas√≥ que alguien te mir√≥ de una forma que te hizo flashear mal?",
            "¬øCu√°l fue el beso que m√°s te dej√≥ pensando despu√©s?",
            "¬øQu√© fantas√≠a tuviste que te sorprendi√≥ a vos mismo/a?",
            "¬øQu√© canci√≥n te transporta directo a una situaci√≥n √≠ntima?",
            "¬øPrefer√≠s que te digan lo que quieren o descubrirlo con el cuerpo?",
            "¬øAlguna vez lloraste despu√©s de tener sexo y no supiste por qu√©?",
            "¬øQu√© te da m√°s morbo: lo prohibido o lo inesperado?",
            "¬øHay algo que siempre quisiste probar pero todav√≠a no te animaste?",
            "¬øQui√©n fue la √∫ltima persona con la que so√±aste algo √≠ntimo?",
            "¬øTe pas√≥ que un simple roce te cambi√≥ todo el d√≠a?",
            "¬øCu√°l fue el momento m√°s √≠ntimo que tuviste sin que haya contacto f√≠sico?"
        ]

    };

    function updateStartButtonState() {
        const hasPlayers = playerNamesInput.value.trim() !== '' || parseInt(playerCount.value) >= 2;
        const hasCategories = document.querySelectorAll('.category-btn.active').length > 0;
        startGameBtn.disabled = !(hasPlayers && hasCategories);
    }

    playerNamesInput.addEventListener('input', updateStartButtonState);

    decreaseBtn.addEventListener('click', function () {
        if (playerCount.value > 2) {
            playerCount.value = parseInt(playerCount.value) - 1;
            updateStartButtonState();
        }
    });

    increaseBtn.addEventListener('click', function () {
        if (playerCount.value < 20) {
            playerCount.value = parseInt(playerCount.value) + 1;
            updateStartButtonState();
        }
    });

    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            this.classList.toggle('active');
            updateStartButtonState();
        });
    });

    updateStartButtonState();

    const buttonsContainer = document.getElementById('buttons-container');
    const loadingText = document.getElementById('loading-text');
    const challengeCompletedBtn = document.getElementById('challenge-completed');
    const challengeFailedBtn = document.getElementById('challenge-failed');
    challengeCompletedBtn.addEventListener('click', () => {
        challengeCompletedBtn.disabled = true;
        challengeFailedBtn.disabled = true;
        nextTurn(1);
    });

    challengeFailedBtn.addEventListener('click', () => {
        challengeCompletedBtn.disabled = true;
        challengeFailedBtn.disabled = true;
        nextTurn(-1);
    });

    const turnInfo = document.getElementById('turn-info');
    const challengeCategory = document.getElementById('challenge-category');
    const challengeText = document.getElementById('challenge-text');

    let players = ['Ana', 'Juan', 'Pedro'];
    let currentPlayerIndex = 0;
    let selectedCategories = ['hot-dares', 'drinking-dares']; // ejemplo
    let playerScores = [];
    let globalScore = 0;

    function initializeScores() {
        playerScores = new Array(players.length).fill(0);
        globalScore = 0;
        renderScores();
    }

    function renderScores() {
        const scoresDiv = document.getElementById('players-scores');
        scoresDiv.innerHTML = players.map((player, i) =>
            `<div>${player}: ${playerScores[i]}</div>`
        ).join('');
        document.getElementById('global-score').textContent = `Puntaje total: ${globalScore}`;
    }


    function addPointToPlayer(playerIndex) {
        playerScores[playerIndex]++;
        globalScore++;
        renderScores();
    }

    function removePointFromPlayer(playerIndex) {
        playerScores[playerIndex]--;
        globalScore--;
        renderScores();
    }

    function getNextChallenge() {
        turnInfo.textContent = `Turno de: ${players[currentPlayerIndex]}`;

        const cat = selectedCategories[Math.floor(Math.random() * selectedCategories.length)];
        const challenge = challenges[cat][Math.floor(Math.random() * challenges[cat].length)];

        let categoryLabel = '', categoryClass = '';
        switch (cat) {
            case "hot-dares":
                categoryLabel = 'Reto Picante';
                categoryClass = 'hot-dare';
                break;
            case "drinking-dares":
                categoryLabel = 'Reto para Beber';
                categoryClass = 'drink-dare';
                break;
            case "uncomfortable-truths":
                categoryLabel = 'Verdad Inc√≥moda';
                categoryClass = 'uncomfortable-truth';
                break;
            case "intimate-truths":
                categoryLabel = 'Verdad √çntima';
                categoryClass = 'intimate-truth';
                break;
        }

        // Primero ocult√°s los botones y mostr√°s "Pensando..."
        buttonsContainer.classList.add('hidden');
        loadingText.classList.remove('hidden');

        setTimeout(() => {
            challengeCategory.textContent = categoryLabel;
            challengeCategory.className = 'category-label text-white ' + categoryClass;
            challengeText.textContent = challenge;

            // Mostr√°s botones y ocult√°s el texto
            buttonsContainer.classList.remove('hidden');
            loadingText.classList.add('hidden');

            // Asegurarte que los botones est√°n habilitados
            challengeCompletedBtn.disabled = false;
            challengeFailedBtn.disabled = false;
        }, 500);
    }

    function nextTurn(pointsToAdd) {
        // Sum√°s o rest√°s puntos seg√∫n si cumpli√≥ o no  
        if (pointsToAdd > 0) addPointToPlayer(currentPlayerIndex);
        else removePointFromPlayer(currentPlayerIndex);

        // Cambi√°s de jugador
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;

        getNextChallenge();
    }

    startGameBtn.addEventListener('click', () => {
        // Leer nombres o cantidad de jugadores
        if (playerNamesInput.value.trim() !== '') {
            players = playerNamesInput.value.split(',').map(name => name.trim()).filter(name => name !== '');
        } else {
            players = Array.from({ length: parseInt(playerCount.value) }, (_, i) => `Jugador ${i + 1}`);
        }

        // Leer categor√≠as activas
        selectedCategories = [];
        document.querySelectorAll('.category-btn.active').forEach(btn => {
            selectedCategories.push(btn.dataset.category);
        });

        if (players.length < 2 || selectedCategories.length === 0) {
            alert('Ten√©s que poner al menos 2 jugadores y seleccionar alguna categor√≠a');
            return;
        }

        // Ocult√°s setup, mostr√°s juego
        setupForm.classList.add('hidden');
        challengeContainer.classList.remove('hidden');

        currentPlayerIndex = 0;
        initializeScores();
        getNextChallenge();
    });

});